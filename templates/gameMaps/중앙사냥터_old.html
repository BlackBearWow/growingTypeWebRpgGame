<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="https://blackbearwow.github.io/favicon/favicon.ico">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        //변수선언
        //(벽 공중) (물풍선) (부술수있는 장애물) (돈 아이템)
        var can;        //canvas 객체
        var canvasWidth; var canvasHeight;  //canvas의 가로 세로 길이
        var ctx;        //context객체를 얻어야 drawimage와 filltext를 할 수 있음
        var keyBoard = {};//키보드를 입력했는지 아닌지 확인하는 맵
        var leftKeyDown, rightKeyDown, upKeyDown, downKeyDown;
        var mouseX, mouseY; //현재 마우스 x, y좌표 
        var oneBlock=40;
        var main={
            charLevel:1,
            exp:1, maxExp:2,
            levelImageCount:0,  //레벨업 이미지를 순서대로 보여주는 카운트
            hits:new Array(30), //이거와 아래는 맞았을때 데미지 저장?
            hitsCount:30,
            maxHp:10, currentHp:10,
            x:oneBlock*20, y:oneBlock*20, //메인 캐릭터의 x좌표, 메인 캐릭터의 y좌표
            showX:0, showY:0,   //주인공 화면 표현상 x좌표, y좌표
            monsterattackDelay:0,
            sight:3,//좌:0 상:1 우:2 하:3
            walking:0,  //이미지 4개중 어떤 이미지를 보여줄건지의 변수
            money:0,
            imglist:[],
            attackMin:1, attackMax:1,   //물풍선 공격의 최소 최대 공격력
            leftSet:0, rightSet:0, upSet:0, downSet:0, //상하좌우 뭐가 세팅되었는지. 한번 세팅되면 한칸을 움직이기 전까지 다른 방향으로 바꿀 수 없다. 
            leftmoveSum: 0, rightmoveSum: 0, upmoveSum: 0, downmoveSum: 0, //상하좌우를 움직이며 한칸을 넘기면 움직임을 멈춤.
            wbMaxLimitQuantity: 20,  //물풍선을 먹었을떄, 몇개까지 늘어날 수 있는지 한도.
            wbLimitQuantity: 1,  //물풍선을 놓을수 있는 한도
            wbNum: 0,   //현재 물풍선 개수.
            wbMaxLen: 30, wbLen: 1, //물줄기 최대길이, 길이
            speed: 1.2, maxSpeed: 4,
            saveCount: 6000, //6000프레임(60초)가 지날때마다 서버에 저장한다.
        };
        for(var i=0;i<main.hits.length;i++)
            main.hits[i]=0;        

        var halfBlock=oneBlock/2;
        var situation=0;//대화의 상황 순서
        var dialogueCount=-2;//대화중 필요한 변수
        var dialogueNpc=0;//대화중인 npc
        var backgroundx,backgroundy;    //배경 x y좌표 좌표.

        wallList=[
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
           [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        ];
        var obstacleList;  //깰 수 있는 장애물
        var itemList = [];      //0아무것도 없음 1물풍선 2물줄기 3인라인스케이트
        var itemImage = [];     //아이템 이미지
        var waterBalloonList = [];  //물풍선 리스트
        var waterBalloonImage = new Array(8);
        for (var i = 0; i < 8; i++) {
            waterBalloonImage[i] = new Image();
            waterBalloonImage[i].src = ("https://blackbearwow.github.io/image/SkillImage/waterBalloon/waterBalloon" + i + ".png");
        }
        var waterBalloonBoomImage = new Image();
        waterBalloonBoomImage.src = ("https://blackbearwow.github.io/image/water.jpg");

        var monsterList = [];   //몬스터들 정보 리스트
        var moneyList = [];     //이건 아이템과 물풍선 만들면 하자.
        var portalList = [];     //이것도 아이템과 물풍선 말들면 하자.

        var monsterHitDamage = [];  //몬스터가 맞은 데미지를 저장하는 변수. x좌표 ,y좌표, 데미지, 카운트가 저장된다.

        var obstacleImage = new Image();
        obstacleImage.src = "https://blackbearwow.github.io/image/tong.png";

        var lantern;    //건물 안에 있을 때 랜턴 이미지 보이게 하는 변수

        var levelUpImage=new Array(21); //레벨업 이미지
        for(var i=0;i<levelUpImage.length;i++){
            levelUpImage[i]=new Image();
            levelUpImage[i].src="https://blackbearwow.github.io/image/LevelUp/levelUp["+i+"].png";
        }

        var mouseImage=new Image(); //마우스 이미지
        mouseImage.src=("https://blackbearwow.github.io/image/cursor.png");

        var background; //배경 이미지 저장변수
        
        var mapWidth; var mapHeight;    //mapwidth mapheight
        var mwBlock; var mhBlock;  //맵가로 몇칸인지, 맵세로 몇칸인지

        var statusShow = 0; //상태창을 보일지 말지. 최대물풍선개수, 물줄기 길이, 속도, 돈

        //초기화
        $(document).ready(function(){
            initialize();
        });

        function initialize()
        {

            can=document.getElementById("can");
            canvasWidth=can.width; canvasHeight=can.height;
            ctx=can.getContext("2d");

            ctx.fillStyle='yellow'; ctx.font = "50px Arial";
            ctx.fillText('Loading...',200,200);

            lantern=new Image();
            lantern.src="https://blackbearwow.github.io/image/lantern1.png";

            main.imglist=[
                [new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyLeft0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyLeft1.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyLeft0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyLeft2.png"),
                ],
                [new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyBack0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyBack1.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyBack0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyBack2.png"),
                ],
                [new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyRight0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyRight1.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyRight0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyRight2.png"),
                ],
                [new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyFront0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyFront1.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyFront0.png"),
                new makecharImage("https://blackbearwow.github.io/image/Character/brownHairBoy/brownHairBoyFront2.png"),
                ],
                new makecharImage("https://blackbearwow.github.io/image/물속.png")
            ];

            //background = new makeBackground("image/Background/background2.png");    //배경이미지
            background = new makeBackground("https://blackbearwow.github.io/image/Background/중앙사냥터.png");    //배경이미지

            background.image.onload = function ()
            {
                mapWidth = background.image.width; mapHeight = background.image.height; mwBlock = mapWidth / oneBlock, mhBlock = mapHeight / oneBlock;

                obstacleList = new Array(mhBlock);
                for (i = 0; i < mhBlock; i++)
                    obstacleList[i] = new Array(mwBlock);
                for (y = 0; y < mhBlock; y++) {
                    for (x = 0; x < mwBlock; x++) {
                        //obstacleList[y][x] = 0;
                        obstacleList[y][x] = {
                            info: 0,    //0빈공간 1장애물
                            pop: 0,    //터지는중이면 1 아니면 0
                            poptime: 0,    //터지는 시간. 50프레임
                        };
                    }
                }

                waterBalloonList = new Array(mhBlock);
                for (i = 0; i < mhBlock; i++)
                    waterBalloonList[i] = new Array(mwBlock);
                for (y = 0; y < mhBlock; y++) {
                    for (x = 0; x < mwBlock; x++) {
                        waterBalloonList[y][x] = {
                            what: 0,    //0빈공간 1물줄기 10물풍선
                            waitTime: 0,    //물풍선인 시간. 100프레임
                            boomTime: 0,    //터지는 시간. 50프레임
                        };
                    }
                }

                itemList = new Array(mhBlock);
                for (i = 0; i < mhBlock; i++)
                    itemList[i] = new Array(mwBlock);

                itemImage = new Array(3);
                itemImage[0] = new Image();
                itemImage[0].src = "https://blackbearwow.github.io/image/Item/Bubble.png"; //물풍선
                itemImage[1] = new Image();
                itemImage[1].src = "https://blackbearwow.github.io/image/Item/Fluid.png";  //물줄기
                itemImage[2] = new Image();
                itemImage[2].src = "https://blackbearwow.github.io/image/Item/Roller.png"; //인라인스케이트

                makeObstacleList();
                makeMonsterList();

                portalList[portalList.length] = new makePotal(0, 20, "/mixedGame/mixedGame서쪽사냥터.html");
                portalList[portalList.length] = new makePotal(20, 39, "/mixedGame/mixedGame남쪽사냥터.html");
                portalList[portalList.length] = new makePotal(39, 20, "/mixedGame/mixedGame동쪽사냥터.html");

                $.ajax({
                    url: "/userinfojson",
                    type: "post",
                    success: function(result){
                        main.wbLimitQuantity=result[0];
                        main.wbLen=result[1];
                        main.speed=result[2];
                        main.money=result[3];
                        main.charLevel=result[4];
                        main.exp=result[5];
                        setMain(main.exp, main.charLevel);
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
                start();
            }
        }


        function start(){
            mainInterval=setInterval(update,10);
            window.addEventListener('keydown',function(e){ keyBoard[e.keyCode]=true; })
            window.addEventListener('keyup',function(e){ keyBoard[e.keyCode]=false; })
            document.getElementById("can").addEventListener('mousemove', function (e) { mouseX = e.offsetX; mouseY = e.offsetY; })
        }

        function saveUserInfo(){
            main.saveCount-=1;
            if(main.saveCount<=0)
            {
                main.saveCount=6000;
                $.ajax({
                    url: "/userinfosave",
                    type: "post",
                    data: {
                        wbMaxNum: main.wbLimitQuantity,
                        wbLen: main.wbLen,
                        speed: main.speed,
                        money: main.money,
                        level: main.charLevel,
                        exp: main.exp,
                    },
                    success: function(result){
                        console.log("저장 성공: "+result);
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }
        }

        function makePotal(x,y,url){//포털 만들기
            this.x=x;
            this.y=y;
            this.url=url;
        }

        function addImage(source){
            this.image=new Image();
            this.image.src=source;
        }
        function makeBackground(source){
            this.image=new Image();
            this.image.src=source;
        }
        function makecharImage(source){
            this.image=new Image();
            this.image.src=source;
        }

        function statusToggle()
        {
            if (statusShow)
                statusShow = 0;
            else
                statusShow = 1;
        }

        function playMusic(id){
            var myAudio = document.getElementById(id); 
            if(myAudio.currentTime==0||myAudio.currentTime==myAudio.duration) { myAudio.play(); } 
        }
        function playMusic2(id){ //효과음
            var myAudio = document.getElementById(id); 
            { myAudio.load(); myAudio.play();} 
        }
        function aud_play_pause(id) { 
            var myAudio = document.getElementById(id); 
            if (myAudio.paused) { myAudio.play(); } 
            else { myAudio.pause(); } 
        }
        function aud_stop(id) { 
            var myAudio = document.getElementById(id); 
            { myAudio.pause(); myAudio.load(); } 
        }
        //장애물들
        function makeObstacleList() {
            for(y=0;y<mhBlock;y++){
                for(x=0;x<mwBlock;x++){
                    if (Math.floor(Math.random() * 10) < 1) {
                        //고정 장애물이 없고, 캐릭터 주변이 아니면 장애물 생기기
                        if ((wallList[y][x] == 0) && !((main.x >= x * 40 - 40) && (main.x <= x * 40 + 40) && (main.y >= y * 40 - 40) && (main.y <= y * 40 + 40)))
                            obstacleList[y][x].info = 1;
                    }
                }
            }
        }
        //장애물 그리기
        function drawObstacles(){
            if (obstacleList == undefined) return;
            for (y = 0; y < mhBlock; y++)
            {
                for (x = 0; x < mwBlock; x++)
                {
                    if (obstacleList[y][x].info)
                        ctx.drawImage(obstacleImage, backgroundx + x * oneBlock, backgroundy + y * oneBlock, oneBlock, oneBlock);
                }
            }
        }
        function obstaclePop()
        {
            for (y = 0; y < mhBlock; y++)
            {
                for (x = 0; x < mwBlock; x++)
                {
                    if (obstacleList[y][x].pop == 1)
                    {
                        obstacleList[y][x].poptime += 1;
                        if (50 < obstacleList[y][x].poptime)
                        {
                            obstacleList[y][x].info = 0;
                            obstacleList[y][x].pop = 0;

                            var probability = Math.random() * 30;
                            if (probability < 10) {
                                if (probability < 5)
                                    itemList[y][x] = 1;
                                else if (probability < 8)
                                    itemList[y][x] = 2;
                                else if (probability < 10)
                                    itemList[y][x] = 3;
                            }
                        }
                    }
                }
            }
        }
        //몬스터
        function addHitMonster(delayTime,betweenAttackTime,damageValue,startX,startY,i){
            this.hitCounts=200+delayTime+i*betweenAttackTime;
            this.damageValue=damageValue;
            this.startX=startX;
            this.startY=startY;
            this.betweenAttackTime=betweenAttackTime;
            this.delayTime=delayTime;
        }
        function makeMonsterList() {
            monsterList.splice(0,monsterList.length);
            for (y = 3; y < mhBlock; y++){
                for (x = 3; x < mwBlock; x++){
                    probability = Math.floor(Math.random() * 15)
                    if (probability < 2)
                    {
                        if (wallList[y][x] != 0) continue;   //해당 블럭이 벽이면 몬스터를 만들지 않음.
                        else if (obstacleList[y][x].info == 1) continue;  //해당 블럭에 장애물이 있으면 몬스터를 만들지 않음.
                        else if ((main.x >= x*40 - 40) && (main.x <= x*40 + 40) && (main.y >= y*40 - 40) && (main.y <= y*40 + 40)) continue; //캐릭터에게 너무 가까이있으면 몬스터를 만들지 않음.

                        if (probability < 1)
                            monsterList[monsterList.length] = new makeMonster(20, 1, "달팽이", x * 40, y * 40, 200, 200, "https://blackbearwow.github.io/image/monster/snail/snail", 10, 40, 40);
                        else if (probability < 2)
                            monsterList[monsterList.length] = new makeMonster(20, 1, "쉬룸", x * 40, y * 40, 200, 200, "https://blackbearwow.github.io/image/monster/Shroom/Shroom", 7, 40, 40);
                    }
                }
            }
        }
        function makeMonster(money,exp,name,x,y,maxHp,hp,NoNumberSource,imageQuantity,width,height){//몬스터 만들기
            this.name=name;
            this.x=x;
            this.y=y;
            this.movingX=0;
            this.movingY=0;
            this.exp=exp;
            this.money=money;
            this.maxHp=maxHp;
            this.hp=hp;
            this.width=width;
            this.height=height;
            this.movingWait=200;
            this.imageCount=0;
            this.imageQuantity=imageQuantity;
            this.image=new Array(imageQuantity);
            for(var i=0;i<imageQuantity;i++){
                this.image[i]=new Image();
                this.image[i].src=NoNumberSource+i+".png";
            }
        }
        function drawMonsters(){
            if(monsterList==undefined) return;
            var a,b=monsterList.length;
            for(a=0;a<b;a++){
                if(monsterList[a].imageCount==0){
                    monsterList[a].imageCount=(monsterList[a].imageQuantity-1)*10;
                }
                //몬스터 hp표시
                ctx.fillStyle="black";
                ctx.fillRect(backgroundx+(monsterList[a].x)-7,backgroundy+(monsterList[a].y)-10,monsterList[a].width+7,10);
                ctx.fillStyle="red";
                ctx.fillRect(backgroundx + (monsterList[a].x) - 5, backgroundy + (monsterList[a].y) - 8, (monsterList[a].hp / monsterList[a].maxHp) * (monsterList[a].width + 3), 6);
                //몬스터 본체 표시
                ctx.drawImage(monsterList[a].image[monsterList[a].imageQuantity - 1 - Math.floor(monsterList[a].imageCount / 10)], backgroundx + monsterList[a].x, backgroundy + monsterList[a].y, monsterList[a].width, monsterList[a].height);
                //몬스터의 이미지 카운트
                monsterList[a].imageCount--;
            }
        }
        function drawMonstersHitDamage(){ 
            if (monsterList == undefined) return;
            ctx.font = "30px Arial";
            ctx.lineWidth = 3;
            for (var i = 0; i < monsterHitDamage.length; i++)
            {
                ctx.shadowColor = "black";
                ctx.shadowBlur = 3;
                ctx.strokeText(monsterHitDamage[i][2], backgroundx + monsterHitDamage[i][0], backgroundy + monsterHitDamage[i][1] - monsterHitDamage[i][3]);
                ctx.shadowBlur = 0;
                ctx.fillStyle = "yellow";
                ctx.fillText(monsterHitDamage[i][2], backgroundx + monsterHitDamage[i][0], backgroundy + monsterHitDamage[i][1] - monsterHitDamage[i][3]);
                monsterHitDamage[i][3] += 1;
                if (monsterHitDamage[i][3] > 100) {
                    monsterHitDamage.pop(i); //i -= 1;
                }
            }
        }
        function monsterHit(){//캐릭터가 몬스터를 공격함
            if(monsterList==undefined) return;
            var a,b=monsterList.length;
            for (a = 0; a < b; a++){
                if (waterBalloonList[Math.floor(monsterList[a].y / 40)][Math.floor(monsterList[a].x / 40)].what == 1) {    //몬스터가 물풍선에 맞는다면
                    var damage = Math.floor(Math.random()*(main.attackMax-main.attackMin)+main.attackMin+1);//이 칸에 이제 캐릭터의 공격력을 넣어야됨.
                    monsterList[a].hp -= damage;
                    monsterHitDamage[monsterHitDamage.length] = [monsterList[a].x, monsterList[a].y, damage, 0];
                }
            }
        }
        function monsterAttack(){//몬스터가 캐릭터를 공격함
            if(monsterList==undefined) return;
            var a,b=monsterList.length;
            for(a=0;a<b;a++){
                if((monsterList[a].y<main.y+40)&&(monsterList[a].y+monsterList[a].height>main.y)&&(monsterList[a].x<main.x+40)&&(monsterList[a].x+monsterList[a].width>main.x)){
                    main.hits[0]=Math.floor(Math.random()*3+1); //주인공이 몬스터에게 접촉시 닳는 데미지.
                    main.hitsCount=main.hits.length;
                    main.currentHp-=main.hits[0];
                    main.monsterattackDelay=20;
                }
            }
        }
        function monsterDie(){//이 함수는 맵 뒤에 실행하지 않으면 canvas에서 오류를 일으킴 * 오류 수정함 
            if(monsterList==undefined) return;
            for(var a=0;a<monsterList.length;a++)
            if(monsterList[a].hp<=0) {
                main.money+=monsterList[a].money; main.exp+=monsterList[a].exp; monsterList.splice(a,1); a-=1;playMusic2('monsterdie');
                if(main.exp>=main.maxExp){ playMusic2('levelUp'); main.levelImageCount=210; setMain(main.exp-main.maxExp,main.charLevel+1); }
            }
        }
        function moveMonster() {
            if (monsterList == undefined) return;
            for (var i = 0; i < monsterList.length; i++) {
                monsterList[i].movingWait -= 1;
                //160프레임동안 움직이고 무빙이 0이 되었다면 기다리는 시간을 설정한다. 기본40프레임+알파만큼 기다리고 160부터 움직이기 시작한다.
                if (monsterList[i].movingWait < 0) { monsterList[i].movingWait = 200 + (Math.floor(Math.random() * 40)); }
                //0~160프레임 사이에는 0.25씩 움직인다.
                else if (monsterList[i].movingWait < 160 && monsterList[i].movingWait >= 0) { monsterList[i].x += monsterList[i].movingX; monsterList[i].y += monsterList[i].movingY; }
                else if (monsterList[i].movingWait == 160)   //160프레임동안 0.25씩 움직여서 40을 움직인다.
                {
                    var probability = Math.floor(Math.random() * 9);
                    if ((probability == 0) && (monsterList[i].x >= 80) && (monsterList[i].y >= 80)) //왼쪽 위
                    {
                        monsterList[i].movingX = -0.25; monsterList[i].movingY = -0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) - 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) - 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) - 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) - 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 1) && (monsterList[i].y >= 80))    //위
                    {
                        monsterList[i].movingX = 0; monsterList[i].movingY = -0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) - 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) - 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40); kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40); kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 2) && (monsterList[i].x < mapWidth - 80) && (monsterList[i].y >= 80))  //오른쪽 위
                    {
                        monsterList[i].movingX = 0.25; monsterList[i].movingY = -0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) - 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) - 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) + 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) + 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 3) && (monsterList[i].x >= 80))    //왼쪽
                    {
                        monsterList[i].movingX = -0.25; monsterList[i].movingY = 0;
                        for (var ka = Math.floor(monsterList[i].y / 40); ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40); ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) - 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) - 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 4))    //제자리
                    {
                        monsterList[i].movingX = 0; monsterList[i].movingY = 0;
                        for (var ka = Math.floor(monsterList[i].y / 40); ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40); ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40); kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40); kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 5) && (monsterList[i].x < mapWidth - 80))  //오른쪽
                    {
                        monsterList[i].movingX = 0.25; monsterList[i].movingY = 0;
                        for (var ka = Math.floor(monsterList[i].y / 40); ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40); ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) + 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) + 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 6) && (monsterList[i].x >= 80) && (monsterList[i].y < mapHeight - 80)) //왼쪽 아래
                    {
                        monsterList[i].movingX = -0.25; monsterList[i].movingY = 0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) + 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) + 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) - 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) - 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 7) && (monsterList[i].y < mapHeight - 80)) //아래
                    {
                        monsterList[i].movingX = 0; monsterList[i].movingY = 0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) + 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) + 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40); kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40); kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else if ((probability == 8) && (monsterList[i].x < mapWidth - 80) && (monsterList[i].y < mapHeight - 80))   //오른쪽 아래
                    {
                        monsterList[i].movingX = 0.25; monsterList[i].movingY = 0.25;
                        for (var ka = Math.floor(monsterList[i].y / 40) + 1; ka <= Math.floor((monsterList[i].y + monsterList[i].height - 1) / 40) + 1; ka++)
                            for (var kb = Math.floor(monsterList[i].x / 40) + 1; kb <= Math.floor((monsterList[i].x + monsterList[i].width - 1) / 40) + 1; kb++)
                                if ((obstacleList[ka][kb].info != 0) || (wallList[ka][kb] != 0)) { monsterList[i].movingX = 0; monsterList[i].movingY = 0; return; }
                    }
                    else { monsterList[i].movingX = 0; monsterList[i].movingY = 0; }
                }
            }
        }

        function drawItem()
        {
            for (y = 0; y < mhBlock; y++) {
                for (x = 0; x < mwBlock; x++) {
                    if (itemList[y][x])
                        ctx.drawImage(itemImage[itemList[y][x] - 1], backgroundx + x * oneBlock, backgroundy + y * oneBlock, oneBlock, oneBlock);
                }
            }
        }

        function setMain(exp, level) {
            main.maxHp = level * 100; main.exp = exp; main.charLevel = level; main.maxExp = level * level; main.currentHp = main.maxHp; main.attackMax = level;
        }
        
        function charBlock(Y,X,k,m){ return wallList[main.y/oneBlock+Y][main.x/oneBlock+X]; }

        function waterBalloonSet()
        {
            if (keyBoard[32])
            {
                var x = Math.round(main.x / oneBlock);
                var y = Math.round(main.y / oneBlock);
                if ((wallList[y][x] == 0) && (obstacleList[y][x].info == 0) && (waterBalloonList[y][x].what == 0))
                {
                    if (main.wbNum >= main.wbLimitQuantity)
                        return;
                    playMusic2("balloonSet");
                    waterBalloonList[y][x].what = 10;
                    waterBalloonList[y][x].waitTime = 100;
                    main.wbNum += 1;
                }
            }
        }
        function drawWaterBalloon()
        {
            for (var y = 0; y < mhBlock; y++)
            {
                for (var x = 0; x < mwBlock; x++)
                {
                    if (waterBalloonList[y][x].what == 10)
                        ctx.drawImage(waterBalloonImage[waterBalloonList[y][x].waitTime % 8], backgroundx + x * oneBlock - 27, backgroundy + y * oneBlock - 36, 90, 90);
                    else if (waterBalloonList[y][x].what == 1)
                        ctx.drawImage(waterBalloonBoomImage, backgroundx + x * oneBlock, backgroundy + y * oneBlock, oneBlock, oneBlock);
                }
            }
        }
        function waterballoonTimeCount()
        {
            for (var y = 0; y < mhBlock; y++)
            {
                for (var x = 0; x < mwBlock; x++)
                {
                    if (waterBalloonList[y][x].what == 10)  //물풍선상태라면
                    {
                        waterBalloonList[y][x].waitTime -= 1;
                        if (waterBalloonList[y][x].waitTime < 0)    //시간이 다되면 풍선이 터짐.
                            waterBalloonPop(x, y);
                    }
                    else if (waterBalloonList[y][x].what == 1)    //물줄기상태라면
                    {
                        waterBalloonList[y][x].boomTime -= 1;
                        if (waterBalloonList[y][x].boomTime < 0)
                            waterBalloonList[y][x].what = 0;
                    }
                }
            }
        }
        function waterBalloonPop(x, y)
        {
            waterBalloonList[y][x].boomTime = 50;
            waterBalloonList[y][x].what = 1;    //물줄기상태이다.
            main.wbNum -= 1;
            playMusic2("balloonBoom");
            for (var i = 1; i <= main.wbLen; i++)   //왼쪽
            {
                if (((x - i) < 0) || (wallList[y][x - i] == 1)) //맵 밖으로 나가거나 벽 만나면 반복문 종료
                    break;
                else if (obstacleList[y][x - i].info == 1)  //장애물 만나면 블록 터뜨리기
                {
                    obstacleList[y][x - i].pop = 1;
                    obstacleList[y][x - i].poptime = 0;
                    break;
                }
                else if (waterBalloonList[y][x - i].what == 10)
                    waterBalloonPop(x - i, y)
                else
                {
                    waterBalloonList[y][x - i].what = 1;
                    waterBalloonList[y][x - i].boomTime = 50;
                    itemList[y][x - i] = 0;
                }
            }
            for (var i = 1; i <= main.wbLen; i++)   //오른쪽
            {
                if (((x + i) >= mwBlock) || (wallList[y][x + i] == 1)) //맵 밖으로 나가거나 벽 만나면 반복문 종료
                    break;
                else if (obstacleList[y][x + i].info == 1) {    //장애물 만나면 블록 터뜨리기
                    obstacleList[y][x + i].pop = 1;
                    obstacleList[y][x + i].poptime = 0;
                    break;
                }
                else if (waterBalloonList[y][x + i].what == 10)
                    waterBalloonPop(x + i, y)
                else {
                    waterBalloonList[y][x + i].what = 1;
                    waterBalloonList[y][x + i].boomTime = 50;
                    itemList[y][x + i] = 0;
                }
            }
            for (var i = 1; i <= main.wbLen; i++)   //위쪽
            {
                if (((y - i) < 0) || (wallList[y - i][x] == 1)) //맵 밖으로 나가거나 벽 만나면 반복문 종료
                    break;
                else if (obstacleList[y - i][x].info == 1) {    //장애물 만나면 블록 터뜨리기
                    obstacleList[y - i][x].pop = 1;
                    obstacleList[y - i][x].poptime = 0;
                    break;
                }
                else if (waterBalloonList[y - i][x].what == 10)
                    waterBalloonPop(x, y - i)
                else {
                    waterBalloonList[y - i][x].what = 1;
                    waterBalloonList[y - i][x].boomTime = 50;
                    itemList[y - i][x] = 0;
                }
            }
            for (var i = 1; i <= main.wbLen; i++)   //아래쪽
            {
                if (((y + i) >= mhBlock) || (wallList[y + i][x] == 1)) //맵 밖으로 나가거나 벽 만나면 반복문 종료
                    break;
                else if (obstacleList[y + i][x].info == 1) {    //장애물 만나면 블록 터뜨리기
                    obstacleList[y + i][x].pop = 1;
                    obstacleList[y + i][x].poptime = 0;
                    break;
                }
                else if (waterBalloonList[y + i][x].what == 10)
                    waterBalloonPop(x, y + i)
                else {
                    waterBalloonList[y + i][x].what = 1;
                    waterBalloonList[y + i][x].boomTime = 50;
                    itemList[y + i][x] = 0;
                }
            }
        }
        
        function ifLeftKeyDown(){
            main.sight=0;
            if(main.leftSet==0){ main.leftSet=1; }
        }
        function ifRightKeyDown(){
            main.sight=2;
            if(main.rightSet==0){ main.rightSet=1; }
        }
        function ifUpKeyDown(){
            main.sight=1;
            if(main.upSet==0){ main.upSet=1; }
        }
        function ifDownKeyDown(){
            main.sight=3;
            if(main.downSet==0){ main.downSet=1; }
        }
        function drawInformation(){
            ctx.font="50px Comic Sans MS";
            ctx.fillStyle = "red";
            ctx.fillText(12,10,50);
        }
        function drawStatus(){
            ctx.fillStyle="tomato"; ctx.fillRect(0,800,1200,28);
            ctx.fillStyle='#999999'; ctx.fillRect(2,802,1196,24);
            ctx.fillStyle="maroon"; ctx.fillRect(0,802,1200*main.currentHp/main.maxHp,24);
            ctx.fillStyle='black'; ctx.font = "20px Arial"; ctx.fillText('HP:'+main.currentHp+'/'+main.maxHp,30,822);
            ctx.fillStyle="Aqua"; ctx.fillRect(0,828,1200,28);
            ctx.fillStyle='#999999'; ctx.fillRect(202,830,1196,24);
            ctx.fillStyle="Lime"; ctx.fillRect(200,830,1000*main.exp/main.maxExp,24);
            ctx.fillStyle="#0039e6"; ctx.fillRect(0,830,200,24);
            ctx.fillStyle='black'; ctx.font = "20px Arial"; ctx.fillText('Exp:'+main.exp+'/'+main.maxExp,220,850); 
            ctx.fillText('Level:' + main.charLevel, 30, 850);

            if (statusShow)
            {
                var startX = 100;
                var startY = 100;
                ctx.fillStyle = "black"; ctx.fillRect(startX, startY, 220, 220);
                ctx.fillStyle = 'white'; ctx.fillRect(startX + 2, startY+2, 216, 216);
                ctx.fillStyle = 'black'; ctx.font = "20px Arial";
                ctx.fillText('최대물풍선개수:' + main.wbLimitQuantity, startX + 20, startY+40);
                ctx.fillText('물줄기 길이:' + main.wbLen, startX + 20, startY+80);
                ctx.fillText('속도:' + main.speed, startX + 20, startY+120);
                ctx.fillText('돈:' + main.money, startX + 20, startY+160);
            }
        }
        function setBackgroundCoordinate()
        {
            if (main.x <= 600 - halfBlock) { backgroundx = 0; main.showX = main.x; }
            else if (main.x > 600 - halfBlock && main.x <= mapWidth - (600 + halfBlock)) { backgroundx = -main.x + 600 - halfBlock; main.showX = 600 - halfBlock; }
            else if (main.x > mapWidth - (600 + halfBlock)) { backgroundx = -mapWidth + 1200; main.showX = main.x - mapWidth + 1200; }
            if (main.y <= 400 - halfBlock) { backgroundy = 0; main.showY = main.y; }
            else if (main.y > 400 - halfBlock && main.y <= mapHeight - (400 + halfBlock)) { backgroundy = -main.y + 400 - halfBlock; main.showY = 400 - halfBlock; }
            else if (main.y > mapHeight - (400 + halfBlock)) { backgroundy = -mapHeight + 800; main.showY = main.y - mapHeight + 800; }
        }
        function moveMap()
        {
            //portalList를 활용해서 잘 만들어 보자.
            if ((main.x % oneBlock == 0) && (main.y % oneBlock) == 0) 
            {
                for (i=0;i<portalList.length;i++)
                {
                    if((main.x == portalList[i].x *40)&&(main.y == portalList[i].y *40))
                    {
                        var num=i;
                        clearInterval(mainInterval);
                        $.ajax({
                            url: "/userinfosave",
                            type: "post",
                            data: {
                                wbMaxNum: main.wbLimitQuantity,
                                wbLen: main.wbLen,
                                speed: main.speed,
                                money: main.money,
                                level: main.charLevel,
                                exp: main.exp,
                            },
                            success: function(result){
                                console.log("저장 성공: "+result);
                                location.href=portalList[num].url;
                            },
                            error: function(error){
                                console.log(error);
                                location.href=portalList[num].url;
                            }
                        });
                    }
                }
            }
        }
        function mainCharMove()
        {
            if ((main.x % oneBlock == 0) && (main.y % oneBlock) == 0) {
                if ((main.sight == 1) || (main.sight == 3)) {   //상 하 방향을 보고있을 때
                    if (leftKeyDown) {
                        main.sight = 0; if ((charBlock(0, -1) == 0) && (obstacleList[main.y / oneBlock][main.x / oneBlock - 1].info == 0)) ifLeftKeyDown();
                    }
                    else if (rightKeyDown) {
                        main.sight = 2; if ((charBlock(0, +1) == 0) && (obstacleList[main.y / oneBlock][main.x / oneBlock + 1].info == 0)) ifRightKeyDown();
                    }
                    else if (upKeyDown) { main.sight = 1; if ((charBlock(-1, 0) == 0) && (obstacleList[main.y / oneBlock - 1][main.x / oneBlock].info == 0)) ifUpKeyDown(); }
                    else if (downKeyDown) { main.sight = 3; if ((charBlock(+1, 0) == 0) && (obstacleList[main.y / oneBlock + 1][main.x / oneBlock].info == 0)) ifDownKeyDown(); }
                }
                else if ((main.sight == 0) || (main.sight == 2)) {  //좌 우 방향을 보고있을 때
                    if (upKeyDown) {
                        main.sight = 1; if ((charBlock(-1, 0) == 0) && (obstacleList[main.y / oneBlock - 1][main.x / oneBlock].info == 0)) ifUpKeyDown();
                    }
                    else if (downKeyDown) { main.sight = 3; if ((charBlock(+1, 0) == 0) && (obstacleList[main.y / oneBlock + 1][main.x / oneBlock].info == 0)) ifDownKeyDown(); }
                    else if (leftKeyDown) { main.sight = 0; if ((charBlock(0, -1) == 0) && (obstacleList[main.y / oneBlock][main.x / oneBlock - 1].info == 0)) ifLeftKeyDown(); }
                    else if (rightKeyDown) { main.sight = 2; if ((charBlock(0, +1) == 0) && (obstacleList[main.y / oneBlock][main.x / oneBlock + 1].info == 0)) ifRightKeyDown(); }
                }
            }
            //상하좌우 움직이기
            if (main.leftSet) {
                main.x -= main.speed;
                main.leftmoveSum += main.speed;
                main.walking += 0.5; if (main.walking >= 3) main.walking = 0; //부동소수점방식이라서 main.walking+=0.5로 지정했다가는 딱 3으로 되지 않아서 오류가 걸린다. >=로 하면 해결.
                if (main.leftmoveSum >= oneBlock) { main.x = Math.round(main.x / oneBlock) * oneBlock; main.leftmoveSum = 0; main.leftSet = 0; main.walking = 0; }
            }
            else if (main.rightSet) {
                main.x += main.speed;
                main.rightmoveSum += main.speed;
                main.walking += 0.0625; if (main.walking >= 3) main.walking = 0;
                if (main.rightmoveSum >= oneBlock) { main.x = Math.round(main.x / oneBlock) * oneBlock; main.rightmoveSum = 0; main.rightSet = 0; main.walking = 0; }
            }
            if (main.upSet) {
                main.y -= main.speed;
                main.upmoveSum += main.speed;
                main.walking += 0.0625; if (main.walking >= 3) main.walking = 0;
                if (main.upmoveSum >= oneBlock) { main.y = Math.round(main.y / oneBlock) * oneBlock; main.upmoveSum = 0; main.upSet = 0; main.walking = 0; }
            }
            else if (main.downSet) {
                main.y += main.speed;
                main.downmoveSum += main.speed;
                main.walking += 0.0625; if (main.walking >= 3) main.walking = 0;
                if (main.downmoveSum >= oneBlock) { main.y = Math.round(main.y / oneBlock) * oneBlock; main.downmoveSum = 0; main.downSet = 0; main.walking = 0; }
            }
        }
        function getItem()  //아이템을 먹는다면?
        {
            if ((main.x % oneBlock == 0) && (main.y % oneBlock == 0)) //아이템 먹는다면?
            { 
                if (itemList[main.y / oneBlock][main.x / oneBlock] != 0)
                {
                    if (itemList[main.y / oneBlock][main.x / oneBlock] == 1) { //물풍선을 먹었다면 물풍선 가능개수 증가
                        itemList[main.y / oneBlock][main.x / oneBlock] = 0;
                        if (main.wbLimitQuantity < main.wbMaxLimitQuantity) main.wbLimitQuantity += 1;
                        playMusic2("item");
                    }
                    else if (itemList[main.y / oneBlock][main.x / oneBlock] == 2) { //물줄기를 먹었다면 물줄기 길이 증가
                        itemList[main.y / oneBlock][main.x / oneBlock] = 0;
                        if (main.wbLen < main.wbMaxLen) main.wbLen += 1;
                        playMusic2("item");
                    }
                    else if (itemList[main.y / oneBlock][main.x / oneBlock] == 3) { //롤러브레이드를 먹었다면 스피드 증가
                        itemList[main.y / oneBlock][main.x / oneBlock] = 0;
                        main.speed += 0.1;
                        if (main.maxSpeed < main.speed) main.speed = main.maxSpeed;
                        playMusic2("item");
                    }
                }
            }
        }
        
        function update(){
            playMusic("KerningSquare"); //배경음악 설정.

            leftKeyDown = keyBoard[37]; rightKeyDown = keyBoard[39];
            upKeyDown = keyBoard[38]; downKeyDown = keyBoard[40];
            //HP를 화면에 sprite할때 전체화면색갈을 초기화시키지 않으면 렉이 걸리면서 끊김
            ctx.fillStyle='#000000';
            ctx.fillRect(0,0,canvasWidth,canvasHeight);
            setBackgroundCoordinate();  //배경이미지 좌표 설정
            moveMap();  //맵 움직이기
            mainCharMove(); //주인공 움직이기
            
            getItem(); //아이템을 먹는다면?
            ctx.drawImage(background.image,backgroundx,backgroundy,mapWidth,mapHeight);
            drawObstacles();

            drawItem();

            waterBalloonSet();
            drawWaterBalloon();
            waterballoonTimeCount();
            obstaclePop();

            //drawInformation();
            drawMonsters();
            drawMonstersHitDamage();
            monsterHit(); //캐릭터가 몬스터를 공격함
            monsterDie();
            moveMonster();
            if(!main.monsterattackDelay) monsterAttack();   //몬스터가 캐릭터를 공격함
            else main.monsterattackDelay-=1;
            if(main.hitsCount!=0){main.hitsCount-=1; //캐릭이 몬스터에게 맞고 난 후 데미지 표시
                for(var i=main.hits.length-1;i>=0;i--){
                    ctx.font = "30px Arial";
                    ctx.shadowColor="black";
                    ctx.shadowBlur=3;
                    ctx.lineWidth=3;
                    if(main.hits[i]) ctx.strokeText(main.hits[i],main.showX-7,main.showY-i*3);
                    ctx.shadowBlur=0;
                    ctx.fillStyle="blueViolet";
                    if(main.hits[i]) ctx.fillText(main.hits[i],main.showX-7,main.showY-i*3);
                    if(i!=(main.hits.length-1)) main.hits[i+1]=main.hits[i];
                    main.hits[i]=0;
                }
            }
            if(main.levelImageCount){//레벨업했을때 이펙트
                main.levelImageCount--;
                ctx.drawImage(levelUpImage[20-Math.floor(main.levelImageCount/10)],main.showX-180,main.showY-220,400,400);
            }
            ctx.drawImage(main.imglist[main.sight][Math.floor(main.walking)].image,main.showX,main.showY-oneBlock*0.2,oneBlock,oneBlock*1.2);  //주인공 그리기
            drawStatus();
            ctx.drawImage(mouseImage,mouseX,mouseY,30,30);//draw mouseCursor

            saveUserInfo();
        }
        
    </script>
</head>
    <body style="background-color:black">
    <center>
    <canvas id="can" width="1200" height="856" style=" cursor:none;"/>
    <!--0~800화면. ~828에이치피 ~856exp  1200 856 border:1px solid #c3c3c3;-->
    </center>
    <div style='display:block;'>
        <audio class="musics" id="Sugar" src="https://blackbearwow.github.io/Music/DanceOfTheSugarplumFairy.mp3"/>
        <audio class="musics" id="Fade" src="https://blackbearwow.github.io/Music/Fade.mp3"/>
        <audio class="musics" id="Camp" src="https://blackbearwow.github.io/Music/CAMP.mp3"/>
        <audio class="musics" id="balloonBoom" src="https://blackbearwow.github.io/Music/물풍선펑.wav"/>
        <audio class="musics" id="item" src="https://blackbearwow.github.io/Music/아이템.wav"/>
        <audio class="musics" id="balloonSet" src="https://blackbearwow.github.io/Music/물풍선.wav"/>
        <audio class="musics" id="door" src="https://blackbearwow.github.io/Music/문소리.mp3"/>
        <audio class="musics" id="levelUp" src="https://blackbearwow.github.io/Music/렙업.wav"/>
        <audio class="musics" id="monsterdie" src="https://blackbearwow.github.io/Music/monsterdie.swf.mp3"/>
        <audio class="musics" id="KerningSquare" src="https://blackbearwow.github.io/Music/커닝스퀘어.mp3"/>
        <audio class="musics" id="Ib" src="https://blackbearwow.github.io/Music/Ib OST -.mp3"/>
        <audio class="musics" id="oneMissedCall" src="https://blackbearwow.github.io/Music/oneMissedCall.mp3"/>
        <audio class="musics" id="Real Ghost sound" src="https://blackbearwow.github.io/Music/Real Ghost sound.mp3"/>
        <audio class="musics" id="nmh_scream1" src="https://blackbearwow.github.io/Music/nmh_scream1.mp3"/>
    </div>

    <center>
    <div id="adminDiv" style="display:inline;">
    <button onclick="statusToggle()">상태창</button>
        <button onclick="location.href='/GameList.html';">홈페이지 이동</button>
    </div>
    </center>
</body>
</html>